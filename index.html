<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESP32 BioMonitor v19.2 (Mobile & Stable)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        /* --- CSS --- */
        :root {
            --bg-sidebar: #1e293b; --bg-main: #f1f5f9; --bg-card: #ffffff;
            --text-main: #0f172a; --text-sub: #334155; --brand: #3b82f6;
            --accent: #0ea5e9; --border: #e2e8f0; --radius: 6px;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* Themes */
        body[data-theme="zen"] { --bg-sidebar:#4b4b42; --bg-main:#f4f4f0; --bg-card:#fdfdfb; --text-main:#2c2c28; --brand:#657c58; --accent:#8a9a5b; }
        body[data-theme="sakura"] { --bg-sidebar:#5e4b52; --bg-main:#fff0f5; --bg-card:#ffffff; --text-main:#4a3b42; --brand:#db7093; --accent:#ffb7c5; }
        body[data-theme="mono"] { --bg-sidebar:#000; --bg-main:#eee; --bg-card:#fff; --text-main:#000; --brand:#333; --accent:#666; --border:#000; --radius:0; }

        body { font-family: "Segoe UI", sans-serif; margin: 0; background: var(--bg-main); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* Layout */
        .sidebar { width: 260px; background: var(--bg-sidebar); color: #e2e8f0; display: flex; flex-direction: column; padding: 20px 15px; overflow-y: auto; flex-shrink: 0; z-index: 100; }
        .sidebar h3 { text-align: center; color: #fff; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; font-weight: 700; letter-spacing: 1px; }
        .nav-btn { background: transparent; color: rgba(255,255,255,0.7); border: none; padding: 12px 15px; text-align: left; cursor: pointer; border-radius: var(--radius); margin-bottom: 5px; width: 100%; display: block; font-size: 0.95rem; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-btn.active { background: var(--brand); color: #fff; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .main { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* Components */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 1.2rem; font-weight: 700; color: var(--text-sub); }
        .btn { padding: 8px 16px; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.9rem; color: white; margin-right: 5px; transition: 0.1s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:disabled { background: #cbd5e1 !important; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background: var(--brand); } .btn-ble { background: #8b5cf6; } 
        .btn-success { background: var(--success); } .btn-danger { background: var(--danger); } 
        .btn-warning { background: var(--warning); } .btn-info { background: var(--accent); }

        /* Dropdown & File Name */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--bg-card); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: var(--radius); border: 1px solid var(--border); }
        .dropdown-content button { color: var(--text-main); padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; border: none; background: none; cursor: pointer; font-size: 0.9rem; }
        .dropdown-content button:hover { background-color: var(--bg-main); color: var(--brand); }
        .dropdown:hover .dropdown-content { display: block; }
        .file-name { font-size: 0.85rem; color: var(--text-sub); margin-right: 10px; font-weight: 600; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Grids & Charts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-box { height: 220px; border: 1px solid var(--border); padding: 5px; border-radius: var(--radius); }
        .live-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-container-live { position: relative; height: 200px; width: 100%; }
        
        /* Baseline Panel */
        .baseline-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .bl-box { text-align: center; border-right: 1px solid #dbeafe; } .bl-box:last-child { border-right: none; }
        .bl-label { font-size: 0.85rem; color: #64748b; font-weight: 600; }
        .bl-value { font-size: 1.4rem; font-weight: 800; color: var(--brand); margin-top: 5px; }
        
        /* Current Value Panel */
        .current-val-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .cv-box { text-align: center; } .cv-label { font-size: 0.9rem; font-weight: 700; color: #065f46; } .cv-value { font-size: 2rem; font-weight: 800; color: #047857; font-family: monospace; }

        /* A4 Report Format */
        .a4-paper { width: 210mm; min-height: 297mm; background: white; padding: 20mm; margin: 0 auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); display: none; border: 1px solid #ddd; color: #000; }
        .report-header { border-bottom: 3px solid var(--brand); padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .report-title { font-size: 24pt; font-weight: 800; }
        
        /* Stats & Logs */
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 10px; }
        .stat-cell { background: #f8fafc; padding: 8px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-label { font-size: 8pt; color: #64748b; display: block; }
        .stat-val { font-size: 11pt; font-weight: 700; font-family: monospace; color: #0f172a; }
        .report-chart { height: 250px; width: 100%; border: 1px solid #e2e8f0; padding: 5px; margin-bottom: 10px; }
        .event-log-box { border: 1px solid #ef4444; background: #fef2f2; padding: 10px; font-size: 9pt; max-height: 150px; overflow-y: auto; margin-bottom: 30px; }
        .event-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #fca5a5; padding: 4px 0; color: #991b1b; }
        .log-empty { color: var(--success); font-style: italic; text-align: center; padding: 5px; }

        /* All-in-One Specifics */
        #allInOneArea { background: var(--bg-card); padding: 25px; border-radius: var(--radius); margin-bottom: 20px; }
        .gauge-container { position: relative; height: 260px; display: flex; justify-content: center; align-items: center; }
        .score-display { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .score-val { font-size: 4rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .math-box { margin-top: 20px; padding: 15px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: var(--radius); color: #064e3b; font-size: 0.9rem; line-height: 1.6; margin-bottom: 30px; }
        .section-divider { display: flex; align-items: center; margin: 40px 0 20px 0; font-weight: 700; color: var(--brand); font-size: 1.2rem; }
        .section-divider::before { content:""; flex: 1; height: 3px; background: var(--border); margin-right: 15px; }
        .section-divider::after { content:""; flex: 1; height: 3px; background: var(--border); margin-left: 15px; }
        .aio-sub-charts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 25px; width: 100%; }
        .aio-chart-box { height: 180px; border: 1px solid var(--border); border-radius: var(--radius); padding: 5px; background: rgba(0,0,0,0.02); min-width: 0; }

        /* Helpers */
        .tab-content { display: none; } .tab-content.active { display: block; }
        .hidden { display: none !important; } 
        .print-hide { display: none !important; } 
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast { background: #333; color: white; padding: 12px 25px; border-radius: 6px; margin-top: 10px; animation: fade 3s forwards; }
        @keyframes fade { 0%{opacity:0;transform:translateY(20px)} 10%{opacity:1;transform:translateY(0)} 90%{opacity:1} 100%{opacity:0} }
        .ref-list { padding-left: 20px; line-height: 1.8; color: var(--text-sub); }
        .ref-link { color: var(--accent); text-decoration: none; } .ref-link:hover { text-decoration: underline; }
        .settings-group { margin-bottom: 25px; padding: 20px; background: rgba(0,0,0,0.01); border: 1px solid var(--border); border-radius: var(--radius); }
        .form-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .form-row input { text-align: right; padding: 6px; width: 100px; }

        /* === MOBILE / RWD SUPPORT === */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; flex-shrink: 0; }
            .sidebar h3 { display: none; }
            .nav-btn { min-width: 100px; margin-right: 5px; font-size: 0.85rem; padding: 8px 12px; }
            .main { padding: 10px; overflow: visible; }
            .grid-2, .grid-3, .live-grid, .stat-grid, .aio-sub-charts, .baseline-panel, .current-val-panel { grid-template-columns: 1fr !important; gap: 15px; }
            .chart-box, .report-chart, .aio-chart-box { height: 200px; }
            .report-area, .a4-paper { width: 100%; padding: 10px; margin: 0; box-shadow: none; min-height: auto; }
            .report-title { font-size: 18pt; }
            .stat-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="sidebar" id="mySidebar">
    <h3>BioMonitor v19.2</h3>
    <button class="nav-btn active" onclick="switchTab('stress')" data-i18n="nav_stress">å£“åŠ›æª¢æ¸¬ (Live)</button>
    <button class="nav-btn" onclick="switchTab('instant')" data-i18n="nav_instant">å³æ™‚ç›£æ§ (Instant)</button>
    <button class="nav-btn" onclick="switchTab('analysis')" data-i18n="nav_analysis">æ•¸æ“šåˆ†æ (Report)</button>
    <button class="nav-btn" onclick="switchTab('allinone')" data-i18n="nav_merged">Beta All-in-One</button>
    <button class="nav-btn" onclick="switchTab('reference')" data-i18n="nav_ref">è³‡æ–™ä¾†æº</button>
    <button class="nav-btn" onclick="switchTab('settings')" data-i18n="nav_settings">åƒæ•¸è¨­å®š</button>
</div>

<div class="main">
    
    <div id="tab-stress" class="tab-content active">
        <div class="card">
            <div class="card-header"><span class="card-title" data-i18n="title_live">å¯¦é©—æ§åˆ¶å°</span>
                <div>
                    <button class="btn btn-ble" onclick="connectBLE()">BLE é€£ç·š</button>
                    <button class="btn btn-primary" onclick="connectUSB()">USB é€£ç·š</button>
                    <button class="btn btn-warning" id="btnCalib" onclick="startCalibration()" disabled data-i18n="btn_calib">æ ¡æ­£</button>
                    <button class="btn btn-success hidden" id="btnMonitor" onclick="startMonitoring()" data-i18n="btn_start">é–‹å§‹</button>
                    <button class="btn btn-danger hidden" id="btnStop" onclick="stopAndReport()" data-i18n="btn_stop">åœæ­¢</button>
                    <button class="btn btn-primary" onclick="downloadCSV()" data-i18n="btn_dl">ä¸‹è¼‰ CSV</button>
                </div>
            </div>
            
            <div class="baseline-panel">
                <div class="bl-box"><div class="bl-label" data-i18n="lbl_base_hr">åŸºæº– HR</div><div class="bl-value" id="dispBaseHR">--</div></div>
                <div class="bl-box"><div class="bl-label" data-i18n="lbl_base_gsr">åŸºæº– GSR</div><div class="bl-value" id="dispBaseGSR">--</div></div>
                <div class="bl-box"><div class="bl-label" data-i18n="lbl_base_resp">åŸºæº– Resp</div><div class="bl-value" id="dispBaseResp">--</div></div>
            </div>

            <div class="current-val-panel">
                <div class="cv-box"><div class="cv-label" data-i18n="lbl_cur_hr">ç•¶å‰ HR (BPM)</div><div class="cv-value" id="valHR">--</div></div>
                <div class="cv-box"><div class="cv-label" data-i18n="lbl_cur_gsr">ç•¶å‰ GSR</div><div class="cv-value" id="valGSR">--</div></div>
                <div class="cv-box"><div class="cv-label" data-i18n="lbl_cur_resp">ç•¶å‰ Resp (RPM)</div><div class="cv-value" id="valResp">--</div></div>
            </div>

            <div class="live-grid">
                <div class="card"><div class="chart-container-live"><canvas id="chartLiveHR"></canvas></div></div>
                <div class="card"><div class="chart-container-live"><canvas id="chartLiveGSR"></canvas></div></div>
                <div class="card"><div class="chart-container-live"><canvas id="chartLiveResp"></canvas></div></div>
            </div>
        </div>
    </div>

    <div id="tab-instant" class="tab-content">
        <div class="card" style="margin-bottom:20px;">
             <div class="card-header"><span class="card-title" data-i18n="title_instant">å³æ™‚ç›£æ§ (Raw)</span></div>
        </div>
        <div class="current-val-panel">
            <div class="cv-box"><div class="cv-label">HR Raw</div><div class="cv-value" id="instValHR">--</div></div>
            <div class="cv-box"><div class="cv-label">GSR Raw</div><div class="cv-value" id="instValGSR">--</div></div>
            <div class="cv-box"><div class="cv-label">Resp Raw</div><div class="cv-value" id="instValResp">--</div></div>
        </div>
        <div class="live-grid">
            <div class="chart-box"><canvas id="chartInstHR"></canvas></div>
            <div class="chart-box"><canvas id="chartInstGSR"></canvas></div>
            <div class="chart-box"><canvas id="chartInstResp"></canvas></div>
        </div>
    </div>

    <div id="tab-analysis" class="tab-content">
        <div class="card">
            <div class="card-header"><span class="card-title" data-i18n="title_analysis">æ•¸æ“šä¸­å¿ƒ (Report)</span>
                <div style="display:flex; align-items:center;">
                     <span id="fileNameOriginal" class="file-name"></span>
                     <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFileUpload(this)">
                     <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" data-i18n="btn_import">åŒ¯å…¥ CSV</button>
                     <div class="dropdown">
                        <button class="btn btn-warning" data-i18n="btn_export">åŒ¯å‡ºæ•¸æ“š â–¼</button>
                        <div class="dropdown-content">
                            <button onclick="downloadCSV()">CSV (Raw)</button>
                            <button onclick="exportImage('png','reportArea')">PNG (Image)</button>
                            <button onclick="exportImage('jpg','reportArea')">JPG (Image)</button>
                            <button onclick="exportPDF('reportArea')">PDF (A4 Report)</button>
                        </div>
                     </div>
                </div>
            </div>
        </div>
        
        <div id="reportArea" class="a4-paper" style="margin-top:20px;">
            <div class="report-header">
                <div class="report-title" data-i18n="rep_title">ç”Ÿç†æ•¸æ“šç¶œåˆåˆ†æå ±å‘Š</div>
                <div style="text-align:right;">BioMonitor v19.2<br>Date: <span id="reportDate">--</span></div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-weight:700; color:var(--danger); margin-bottom:5px;">1. å¿ƒç‡åˆ†æ (Heart Rate)</div>
                <div class="stat-grid" id="statHR"></div>
                <div class="report-chart"><canvas id="repChartHR"></canvas></div>
                <div class="event-log-box print-hide" id="logHR"></div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-weight:700; color:var(--warning); margin-bottom:5px;">2. è†šé›»åˆ†æ (GSR)</div>
                <div class="stat-grid" id="statGSR"></div>
                <div class="report-chart"><canvas id="repChartGSR"></canvas></div>
                <div class="event-log-box print-hide" id="logGSR"></div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-weight:700; color:var(--brand); margin-bottom:5px;">3. å‘¼å¸åˆ†æ (Respiration)</div>
                <div class="stat-grid" id="statResp"></div>
                <div class="report-chart"><canvas id="repChartResp"></canvas></div>
                <div class="event-log-box print-hide" id="logResp"></div>
            </div>
            
            <div style="padding:15px; border:2px solid #ddd; background:#f9f9f9;">
                <strong data-i18n="lbl_conclusion">ç¶œåˆçµè«–ï¼š</strong> <span id="compContent">--</span>
            </div>
        </div>
    </div>

    <div id="tab-allinone" class="tab-content">
        <div class="card" id="allInOneArea">
            <div class="card-header"><span class="card-title" data-i18n="title_merged">Beta All-in-One</span>
                <div style="display:flex; align-items:center;">
                    <span id="fileNameAio" class="file-name"></span>
                    <input type="file" id="aioInput" accept=".csv" style="display:none" onchange="handleAioUpload(this)">
                    <button class="btn btn-primary" onclick="document.getElementById('aioInput').click()" data-i18n="btn_import">ä¸Šå‚³ CSV</button>
                    <div class="dropdown">
                        <button class="btn btn-warning" data-i18n="btn_export">åŒ¯å‡ºæ•¸æ“š â–¼</button>
                        <div class="dropdown-content">
                            <button onclick="downloadCSV()">CSV (Raw)</button>
                            <button onclick="exportImage('png','allInOneArea')">PNG (Image)</button>
                            <button onclick="exportImage('jpg','allInOneArea')">JPG (Image)</button>
                            <button onclick="exportPDF('allInOneArea')">PDF (A4 Report)</button>
                        </div>
                     </div>
                </div>
            </div>
            
            <div class="grid-2">
                <div style="text-align:center;">
                    <div class="gauge-container"><canvas id="gaugeChart"></canvas><div class="score-display"><div class="score-val" id="aioScore">--</div><div class="score-text" id="aioStatus">Waiting</div></div></div>
                </div>
                <div>
                    <h4 style="margin:0 0 15px 0; color:var(--text-sub);" data-i18n="lbl_contrib">å£“åŠ›ä¾†æºè²¢ç»åº¦</h4>
                    <div style="height:220px; width:100%;"><canvas id="barContrib"></canvas></div>
                </div>
            </div>
            
            <div class="math-box">
                <strong>ğŸ“Š <span data-i18n="lbl_math">ç®—å¼è§£å¯† (Logic)</span>:</strong> Score = (HR% Ã— 0.6) + (GSR% Ã— 0.3) + (Resp% Ã— 0.1)ã€‚<br>
                <div id="mathLiveCalc" style="margin-top:10px; font-weight:bold; color:var(--success);">Waiting...</div>
            </div>

            <div id="mergedDetailContent" style="display:none; margin-top:40px;">
                <div class="section-divider" data-i18n="sec_detail">è©³ç´°æŒ‡æ¨™åˆ†æ</div>
                
                <div style="margin-bottom:20px;">
                    <div style="font-weight:700; color:var(--danger); margin-bottom:5px;">HR Analysis (BPM)</div>
                    <div class="stat-grid" id="aioStatHR"></div>
                    <div class="aio-sub-charts"><div class="aio-chart-box"><canvas id="aioRepChartHR"></canvas></div></div>
                    <div class="event-log-box print-hide" id="aioLogHR"></div>
                </div>

                <div style="margin-bottom:20px;">
                    <div style="font-weight:700; color:var(--warning); margin-bottom:5px;">GSR Analysis</div>
                    <div class="stat-grid" id="aioStatGSR"></div>
                    <div class="aio-sub-charts"><div class="aio-chart-box"><canvas id="aioRepChartGSR"></canvas></div></div>
                    <div class="event-log-box print-hide" id="aioLogGSR"></div>
                </div>

                <div style="margin-bottom:20px;">
                    <div style="font-weight:700; color:var(--brand); margin-bottom:5px;">Resp Analysis (RPM)</div>
                    <div class="stat-grid" id="aioStatResp"></div>
                    <div class="aio-sub-charts"><div class="aio-chart-box"><canvas id="aioRepChartResp"></canvas></div></div>
                    <div class="event-log-box print-hide" id="aioLogResp"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-reference" class="tab-content">
        <div class="card">
            <div class="card-header"><span class="card-title" data-i18n="title_ref">è³‡æ–™ä¾†æº</span></div>
            <div style="padding:20px;">
                <div class="settings-title">å­¸è¡“æ–‡ç» (Academic)</div>
                <ul class="ref-list">
                    <li>Villarejo, M. V., et al. (2012). "A stress sensor based on Galvanic Skin Response (GSR) controlled by ZigBee."</li>
                    <li>Brouwer, A. M., et al. (2018). "Estimating workload using EEG spectral power and heart rate in a real-world setting."</li>
                    <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC12483753/" target="_blank" class="ref-link">PMC12483753 - Physiological Signal Analysis</a></li>
                    <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2653595/" target="_blank" class="ref-link">PMC2653595 - Stress Detection Research</a></li>
                    <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3872389/#sec5" target="_blank" class="ref-link">PMC3872389 - Multi-modal Signal Fusion</a></li>
                </ul>
                <div class="settings-title" style="margin-top:20px;">ç¶²è·¯è³‡æº (Online)</div>
                <ul class="ref-list">
                    <li><a href="https://web.ntnu.edu.tw/~696010077/Bio%20intro.html" target="_blank" class="ref-link">NTNU Bio Intro</a></li>
                    <li><a href="https://my.clevelandclinic.org/health/diagnostics/heart-rate" target="_blank" class="ref-link">Cleveland Clinic - Heart Rate</a></li>
                    <li><a href="https://zh.wikipedia.org/zh-tw/%E5%91%BC%E5%90%B8%E9%A2%91%E7%8E%87" target="_blank" class="ref-link">Wikipedia - å‘¼å¸é »ç‡</a></li>
                    <li><a href="https://www.eet-china.com/mp/a451365.html" target="_blank" class="ref-link">EET China</a></li>
                    <li><a href="https://www.taiwannutrition.com/blog/chest-breathing-vs-abdominal-breathing/?srsltid=AfmBOop7KB3wJpIxNJUcyMkdC-SJ_BraPcIVYlAmoevH6z8XO1GedvJE" target="_blank" class="ref-link">Taiwan Nutrition</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="card">
            <div class="card-header"><span class="card-title" data-i18n="title_settings">åƒæ•¸è¨­å®š</span></div>
            <div style="padding:15px;">
                <div class="settings-group">
                    <div class="settings-title" data-i18n="set_ui">ä»‹é¢èˆ‡èªè¨€</div>
                    <div style="margin-bottom:15px;">
                        <button class="btn" style="background:#3b82f6" onclick="setTheme('default')">é è¨­ (Tech)</button>
                        <button class="btn" style="background:#657c58" onclick="setTheme('zen')">ç¦ªæ„ (Zen)</button>
                        <button class="btn" style="background:#db7093" onclick="setTheme('sakura')">æ«»èŠ± (Sakura)</button>
                        <button class="btn" style="background:#333" onclick="setTheme('mono')">é»‘ç™½ (Mono)</button>
                    </div>
                    <button class="btn btn-info" onclick="toggleLanguage()">åˆ‡æ›èªè¨€ / Switch Language</button>
                </div>

                <div class="settings-group">
                    <div class="settings-title" data-i18n="set_sys">ç³»çµ±åƒæ•¸</div>
                    <div class="form-row"><label>æ•¸æ“šå›å‚³é »ç‡ (ms)</label><input type="number" id="set_interval" value="100"></div>
                    <div class="form-row"><label>åˆå§‹åŒ–æ ¡æ­£æ™‚é–“ (s)</label><input type="number" id="set_calib" value="60"></div>
                </div>

                <div class="settings-group">
                    <div class="settings-title" data-i18n="set_th">ç·Šå¼µç¨‹åº¦æŒ‡æ¨™ (Thresholds)</div>
                    <div class="form-row"><label>HR å€ç‡ (>Base x)</label><input type="number" id="set_hr_mult" value="1.2" step="0.05"></div>
                    <div class="form-row"><label>GSR å€ç‡ (<Base x)</label><input type="number" id="set_gsr_mult" value="0.9" step="0.05"></div>
                    <div class="form-row"><label>Resp å€ç‡ (>Base x)</label><input type="number" id="set_resp_mult" value="1.25" step="0.05"></div>
                </div>
                <button class="btn btn-success" style="width:100%;" onclick="saveSettings()" data-i18n="btn_save">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === Core Logic ===
    let curLang='zh', rawData=[], monitorData=[], calibrationData=[];
    let baseline={hr:0,gsr:0,resp:0}, settings={interval:100,calib:60,hrMult:1.2,gsrMult:0.9,respMult:1.25};
    let charts={}, appState='idle', aioData=[];
    const bleService="6e400001-b5a3-f393-e0a9-e50e24dcca9e", bleCharTx="6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    const i18n = {
        'zh': {
            nav_stress:'å£“åŠ›æª¢æ¸¬', nav_instant:'å³æ™‚ç›£æ§', nav_analysis:'æ•¸æ“šåˆ†æ (Report)', nav_merged:'Beta All-in-One', nav_ref:'è³‡æ–™ä¾†æº', nav_settings:'åƒæ•¸è¨­å®š',
            console_title:'å¯¦é©—æ§åˆ¶å°', title_live:'å¯¦é©—æ§åˆ¶å°', title_instant:'å³æ™‚ç›£æ§', title_analysis:'æ•¸æ“šä¸­å¿ƒ (Report)', title_merged:'ç¶œåˆå£“åŠ›è©•ä¼°', title_ref:'è³‡æ–™ä¾†æº', title_settings:'åƒæ•¸è¨­å®š',
            btn_calib:'æ ¡æ­£', btn_start:'é–‹å§‹', btn_stop:'åœæ­¢', btn_dl:'ä¸‹è¼‰ CSV', btn_import:'åŒ¯å…¥ CSV', btn_export:'åŒ¯å‡ºæ•¸æ“š â–¼', btn_save:'å„²å­˜è¨­å®š',
            lbl_base_hr:'åŸºæº– BPM', lbl_base_gsr:'åŸºæº– GSR', lbl_base_resp:'åŸºæº– RPM', lbl_cur_hr:'ç•¶å‰ BPM', lbl_cur_gsr:'ç•¶å‰ GSR', lbl_cur_resp:'ç•¶å‰ RPM',
            rep_title:'ç”Ÿç†æ•¸æ“šç¶œåˆåˆ†æå ±å‘Š', lbl_conclusion:'ç¶œåˆçµè«–ï¼š', lbl_contrib:'å£“åŠ›ä¾†æºè²¢ç»åº¦', lbl_math:'ç®—å¼è§£å¯†', sec_detail:'è©³ç´°æŒ‡æ¨™åˆ†æ',
            set_ui:'ä»‹é¢èˆ‡èªè¨€', set_sys:'ç³»çµ±åƒæ•¸', set_th:'ç·Šå¼µç¨‹åº¦æŒ‡æ¨™'
        },
        'en': {
            nav_stress:'Live Monitor', nav_instant:'Instant View', nav_analysis:'Analysis (Report)', nav_merged:'Beta All-in-One', nav_ref:'References', nav_settings:'Settings',
            console_title:'Console', title_live:'Console', title_instant:'Instant View', title_analysis:'Data Center', title_merged:'All-in-One', title_ref:'References', title_settings:'Settings',
            btn_calib:'Calib', btn_start:'Start', btn_stop:'Stop', btn_dl:'Download', btn_import:'Import', btn_export:'Export Data â–¼', btn_save:'Save',
            lbl_base_hr:'Base BPM', lbl_base_gsr:'Base GSR', lbl_base_resp:'Base RPM', lbl_cur_hr:'Cur BPM', lbl_cur_gsr:'Cur GSR', lbl_cur_resp:'Cur RPM',
            rep_title:'Analysis Report', lbl_conclusion:'Conclusion:', lbl_contrib:'Stress Contributors', lbl_math:'Calculation', sec_detail:'Detailed Trends',
            set_ui:'UI & Language', set_sys:'System Params', set_th:'Stress Thresholds'
        }
    };

    window.onload = () => { initCharts(); updateText(); };
    function updateText() { document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = i18n[curLang][e.dataset.i18n]||e.innerText); }
    function toggleLanguage() { curLang=curLang==='zh'?'en':'zh'; updateText(); showToast('Language Switched'); }
    function setTheme(t) { document.body.setAttribute('data-theme', t==='default'?'':t); showToast('Theme: '+t); }
    function showToast(m) { let d=document.createElement('div'); d.className='toast'; d.innerText=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }
    function switchTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); }
    function toggleSidebar() { document.getElementById('mySidebar').classList.toggle('collapsed'); }

    // === Charts Init (Cleaned - No Lab) ===
    function initCharts() {
        Chart.defaults.font.family="Segoe UI"; Chart.defaults.color="#64748b";
        const opt={responsive:true,maintainAspectRatio:false,animation:false,elements:{point:{radius:0},line:{borderWidth:2}},scales:{x:{type:'linear',display:true}}};
        const repOpt={...opt,plugins:{legend:{display:true}},scales:{x:{type:'linear',display:true,title:{display:true,text:'Time (s)'}}}};
        
        ['Live','Inst'].forEach(p => ['HR','GSR','Resp'].forEach(k => charts[p+k] = new Chart(document.getElementById(`chart${p}${k}`), {type:'line', data:{datasets:[{borderColor:getColor(k), data:[]}]}, options:opt})));
        ['HR','GSR','Resp'].forEach(k => charts['Rep'+k] = new Chart(document.getElementById(`repChart${k}`), {type:'line', data:{datasets:[]}, options:repOpt}));
        
        charts.Gauge=new Chart(document.getElementById('gaugeChart'),{type:'doughnut',data:{datasets:[{data:[0,100],backgroundColor:['#e2e8f0','#e2e8f0'],cutout:'80%',circumference:180,rotation:270}]},options:{responsive:true,plugins:{tooltip:{enabled:false}}}});
        charts.Contrib=new Chart(document.getElementById('barContrib'),{type:'bar',data:{labels:['HR','GSR','Resp'],datasets:[{data:[0,0,0],backgroundColor:['#ef4444','#f59e0b','#3b82f6']}]},options:{responsive:true,scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}});
        ['HR','GSR','Resp'].forEach(k => charts['AioRep'+k] = new Chart(document.getElementById(`aioRepChart${k}`), {type:'line', data:{datasets:[]}, options:repOpt}));
    }
    function getColor(k) { return k==='HR'?'#ef4444':k==='GSR'?'#f59e0b':'#3b82f6'; }

    // === Logic ===
    function processData(line) {
        let p = line.split(',');
        let t = Date.now()/1000;
        let d = { t:t, hr:parseInt(p[0])||0, gsr:parseInt(p[1])||0, resp:parseInt(p[2])||0 };
        
        let win = (appState==='monitoring'?monitorData:calibrationData).filter(x => x.t > t-10);
        let avg = (k) => win.length>0 ? (win.reduce((a,b)=>a+b[k],0)/win.length).toFixed(0) : d[k];

        document.getElementById('valHR').innerText = avg('hr');
        document.getElementById('valGSR').innerText = d.gsr;
        document.getElementById('valResp').innerText = avg('resp');
        document.getElementById('instValHR').innerText = d.hr;
        document.getElementById('instValGSR').innerText = d.gsr;
        document.getElementById('instValResp').innerText = d.resp;

        ['HR','GSR','Resp'].forEach(k => {
            let v = k==='HR'?d.hr:k==='GSR'?d.gsr:d.resp;
            updateChart(charts['Live'+k], t, v); updateChart(charts['Inst'+k], t, v);
        });
        if(appState==='monitoring') monitorData.push(d);
        else if(appState==='calibrating') calibrationData.push(d);
    }
    function updateChart(c, x, y) {
        c.data.datasets[0].data.push({x,y});
        if(c.data.datasets[0].data.length > 50) c.data.datasets[0].data.shift();
        c.update('none');
    }

    // === Analysis ===
    function handleFileUpload(input) { processFile(input, 'fileNameOriginal', (d)=>generateReport(d)); }
    function handleAioUpload(input) { processFile(input, 'fileNameAio', (d)=>runAllInOne(d)); }
    
    function processFile(input, nameId, callback) {
        const file = input.files[0];
        if(!file) return;
        document.getElementById(nameId).innerText = `ğŸ“„ ${file.name}`;
        Papa.parse(file, {
            complete: (res) => {
                let data = res.data.slice(1).map((r,i) => ({t:Number(r[0]||i*0.1), hr:Number(r[1]), gsr:Number(r[2]), resp:Number(r[3])})).filter(x=>!isNaN(x.hr));
                if(baseline.hr===0) autoBaseline(data);
                showToast("Read Success");
                callback(data);
            }
        });
    }

    function autoBaseline(d) { let avg=(k)=>d.reduce((a,b)=>a+b[k],0)/d.length; baseline={hr:avg('hr'), gsr:avg('gsr'), resp:avg('resp')}; }

    function generateReport(data) {
        document.getElementById('reportArea').style.display='block';
        document.getElementById('reportDate').innerText = moment().format('YYYY-MM-DD HH:mm');
        updateAllAnalysisCharts(data, 'Rep', 'stat', 'log');
        let avgHR = data.reduce((a,b)=>a+b.hr,0)/data.length;
        document.getElementById('compContent').innerText = avgHR > baseline.hr*1.1 ? "æª¢æ¸¬åˆ°é¡¯è‘—å£“åŠ›åæ‡‰ã€‚" : "å—æ¸¬è€…ç‹€æ…‹å¹³ç©©ã€‚";
    }

    function runAllInOne(data) {
        let total=0, cHR=0, cGSR=0, cResp=0;
        data.forEach(x => {
            let sH = Math.max(0, (x.hr-baseline.hr)/baseline.hr)*300;
            let sG = Math.max(0, (baseline.gsr-x.gsr)/baseline.gsr)*300; 
            let sR = Math.max(0, (x.resp-baseline.resp)/baseline.resp)*100;
            total += Math.min((sH*0.6)+(sG*0.3)+(sR*0.1), 100);
            cHR+=sH; cGSR+=sG; cResp+=sR;
        });
        let score = total/data.length;
        
        charts.Gauge.data.datasets[0].data = [score, 100-score];
        charts.Gauge.data.datasets[0].backgroundColor = [score>60?'#ef4444':score>30?'#f59e0b':'#10b981', '#e2e8f0'];
        charts.Gauge.update();
        document.getElementById('aioScore').innerText = score.toFixed(0);
        document.getElementById('aioStatus').innerText = score>60?"STRESS":score>30?"ALERT":"RELAXED";
        
        let sumC = cHR+cGSR+cResp || 1;
        charts.Contrib.data.datasets[0].data = [(cHR/sumC)*100, (cGSR/sumC)*100, (cResp/sumC)*100];
        charts.Contrib.update();
        document.getElementById('mathLiveCalc').innerText = `Result: ${score.toFixed(1)} / 100`;

        // â˜…â˜…â˜… FIX: SHOW DIV THEN UPDATE CHARTS â˜…â˜…â˜…
        document.getElementById('mergedDetailContent').style.display='block';
        setTimeout(() => {
            updateAllAnalysisCharts(data, 'AioRep', 'aioStat', 'aioLog');
        }, 100);
    }

    function updateAllAnalysisCharts(data, cPre, sPre, lPre) {
        ['HR','GSR','Resp'].forEach(k => {
            let key = k.toLowerCase(), base = baseline[key] || 1;
            let th = base * (k==='GSR' ? settings.gsrMult : settings.hrMult);
            let vals = data.map(d=>d[key]), avg = vals.reduce((a,b)=>a+b,0)/vals.length;
            let min = Math.min(...vals), max = Math.max(...vals);
            let diff = ((avg-base)/base)*100;
            
            let baseLabel = k==='GSR'?'åŸºæº– (Base)':`åŸºæº– (Base) ${k==='HR'?'BPM':'RPM'}`;
            let avgLabel = k==='GSR'?'å¹³å‡ (Avg)':`å¹³å‡ (Avg) ${k==='HR'?'BPM':'RPM'}`;

            document.getElementById(`${sPre}${k}`).innerHTML = `
                <div class="stat-cell"><span class="stat-label">${baseLabel}</span><span class="stat-val">${base.toFixed(1)}</span></div>
                <div class="stat-cell"><span class="stat-label">${avgLabel}</span><span class="stat-val">${avg.toFixed(1)}</span></div>
                <div class="stat-cell"><span class="stat-label">Diff %</span><span class="stat-val">${diff.toFixed(1)}%</span></div>
                <div class="stat-cell"><span class="stat-label">Max</span><span class="stat-val">${max}</span></div>
                <div class="stat-cell"><span class="stat-label">Min</span><span class="stat-val">${min}</span></div>`;

            let chart = charts[`${cPre}${k}`];
            let pts = data.map(d=>({x:d.t, y:d[key]}));
            chart.options.scales.y = { min:Math.min(min,base,th)*0.95, max:Math.max(max,base,th)*1.05 };
            chart.data.datasets = [
                {label:'Data', data:pts, borderColor:getColor(k), borderWidth:2, order:1},
                {label:'Threshold', data:pts.map(p=>({x:p.x,y:th})), borderColor:'#ef4444', borderDash:[5,5], borderWidth:1, fill:true, backgroundColor:'rgba(16,185,129,0.1)', order:2},
                {label:'Base', data:pts.map(p=>({x:p.x,y:base})), borderColor:'#333', borderDash:[2,2], borderWidth:1, order:3}
            ];
            chart.update();
            chart.resize(); // Force resize for mobile/hidden

            let logEl = document.getElementById(`${lPre}${k}`);
            logEl.innerHTML = "";
            let events = [], inEvent = false, startT = 0;
            pts.forEach(p => {
                let isOut = (k==='GSR') ? (p.y < th) : (p.y > th);
                if(isOut && !inEvent) { inEvent = true; startT = p.x; }
                else if(!isOut && inEvent) { inEvent = false; events.push({s:startT, e:p.x}); }
            });
            if(inEvent) events.push({s:startT, e:pts[pts.length-1].x});

            if(events.length === 0) logEl.innerHTML = `<div class="log-empty">Stable</div>`;
            else events.forEach(ev => {
                logEl.innerHTML += `<div class="event-item"><span class="event-time">${ev.s.toFixed(1)}s - ${ev.e.toFixed(1)}s</span><span>[!] è¶…å‡ºæ¨™æº– (${(ev.e-ev.s).toFixed(1)}s)</span></div>`;
            });
        });
    }

    function exportImage(type, id) {
        document.querySelectorAll('.print-hide').forEach(e => e.style.display = 'none');
        html2canvas(document.getElementById(id)).then(c => {
            let link = document.createElement('a'); link.download = `Export.${type}`; link.href = c.toDataURL(`image/${type}`); link.click();
            document.querySelectorAll('.print-hide').forEach(e => e.style.display = 'block');
        });
    }
    function exportPDF(id) { 
        document.querySelectorAll('.print-hide').forEach(e => e.style.display = 'none');
        html2canvas(document.getElementById(id)).then(c => { 
            const pdf=new jspdf.jsPDF('p','mm','a4'); pdf.addImage(c.toDataURL('image/png'),'PNG',0,0,210,297); pdf.save('Report.pdf'); 
            document.querySelectorAll('.print-hide').forEach(e => e.style.display = 'block');
        }); 
    }
    function downloadCSV() { saveAs(new Blob(["Time,HR,GSR,Resp\n"],{type:"text/csv"}), "data.csv"); }
    function saveSettings() { 
        settings.hrMult = parseFloat(document.getElementById('set_hr_mult').value); 
        settings.gsrMult = parseFloat(document.getElementById('set_gsr_mult').value);
        settings.respMult = parseFloat(document.getElementById('set_resp_mult').value);
        showToast("Saved"); 
    }
    
    async function connectBLE() {
        try {
            const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [bleService] });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(bleService);
            const characteristic = await service.getCharacteristic(bleCharTx);
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', (e) => {
                const dec = new TextDecoder('utf-8');
                processData(dec.decode(e.target.value).trim());
            });
            document.getElementById('sysStatus').innerText = translations[currentLang].status_ble_ok;
            document.getElementById('sysStatus').style.color = "#10b981";
            document.getElementById('btnCalib').disabled = false;
            showToast("BLE Connected", "success");
        } catch(e) { showToast("BLE Error: " + e, "error"); }
    }
    async function connectUSB() { if(navigator.serial){ const p=await navigator.serial.requestPort(); await p.open({baudRate:115200}); const r=p.readable.getReader(); while(true){ const {value,done}=await r.read(); if(value) processData(new TextDecoder().decode(value)); if(done)break;} } }
    
    function startCalibration(){ appState='calibrating'; calibrationData=[]; showToast("Calibrating..."); setTimeout(()=>{appState='idle'; autoBaseline(calibrationData); document.getElementById('dispBaseHR').innerText=baseline.hr.toFixed(0); document.getElementById('dispBaseGSR').innerText=baseline.gsr.toFixed(0); document.getElementById('dispBaseResp').innerText=baseline.resp.toFixed(0); showToast("Done"); document.getElementById('btnMonitor').classList.remove('hidden');}, 3000); }
    function startMonitoring(){ appState='monitoring'; monitorData=[]; showToast("Recording..."); document.getElementById('btnStop').classList.remove('hidden'); }
    function stopAndReport(){ appState='idle'; generateReport(monitorData); switchTab('analysis'); }
</script>
</body>
</html>
